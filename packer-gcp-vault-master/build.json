{
  "variables": {
    "project_id": "",
    "zone": "",
    "subnetwork": "",
    "tags": "default-ssh",
    "vault_download_url": "gs://hashicorp-enterprise-binaries/vault/1.2.4/vault-enterprise_1.2.4+prem_linux_amd64.zip",
    "vault_version": "v1-2-4",
    "consul_download_url": "gs://hashicorp-enterprise-binaries/consul/1.6.2/consul-enterprise_1.6.2+prem_linux_amd64.zip"
  },
  "builders": [
    {
      "name": "Vault Image",
      "type": "googlecompute",
      "project_id": "{{user `project_id`}}",
      "source_image_family": "centos-7",
      "source_image_project_id": "gce-uefi-images",
      "zone": "{{user `zone`}}",
      "disk_size": "100",
      "use_internal_ip": false,
      "omit_external_ip": false,
      "subnetwork": "{{user `subnetwork`}}",
      "ssh_username": "packer",
      "communicator": "ssh",
      "tags": ["{{user `tags`}}"],
      "image_description": "Vault image",
      "image_name": "vault-{{user `vault_version`}}-{{timestamp}}"
    },
    {
      "name": "Consul Image",
      "type": "googlecompute",
      "project_id": "{{user `project_id`}}",
      "source_image_family": "centos-7",
      "source_image_project_id": "gce-uefi-images",
      "zone": "{{user `zone`}}",
      "disk_size": "100",
      "use_internal_ip": false,
      "omit_external_ip": false,
      "subnetwork": "{{user `subnetwork`}}",
      "ssh_username": "packer",
      "communicator": "ssh",
      "tags": ["{{user `tags`}}"],
      "image_description": "Vault image",
      "image_name": "consul-{{user `vault_version`}}-{{timestamp}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
          "sudo yum install wget unzip -y",
          "sudo yum install epel-release jq -y"
      ]
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "inline": [
          "echo Create required folders...",
          "mkdir -m777 -p {/tmp/packer-files,/opt/chef/inspec}",
          "echo Completed creating install folder"
      ]
    },
    {
      "type": "file",
      "source": "{{pwd}}/files/",
      "destination": "/tmp/packer-files/"
    },
    {
      "type": "file",
      "source": "{{pwd}}/tests/local/",
      "destination": "/opt/chef/inspec/"
    },
    {
        "type": "shell",
        "environment_vars": [
            "VAULT_DOWNLOAD_URL={{user `vault_download_url`}}"
        ],
        "only": [
            "Vault Image"
        ],
        "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
        "scripts": [
          "{{pwd}}/scripts/install-vault.sh",
          "{{pwd}}/scripts/install-stackdriver.sh"
        ]
    },
    {
        "type": "shell",
        "environment_vars": [
            "CONSUL_DOWNLOAD_URL={{user `consul_download_url`}}"
        ],
        "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
        "scripts": [
            "{{pwd}}/scripts/install-consul.sh",
            "{{pwd}}/scripts/install-pwc-cert.sh",
            "{{pwd}}/scripts/td-agent-bit.sh",
            "{{pwd}}/scripts/telegraf.sh",
            "{{pwd}}/scripts/install-inspec.sh"
        ]
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "inline": [
          "chmod 0775 /tmp/packer-files/run_inspec.sh",
          "cp /tmp/packer-files/inspec.service /etc/systemd/system/",
          "cp /tmp/packer-files/inspec.timer /etc/systemd/system/",
          "cp /tmp/packer-files/run_inspec.sh /opt/chef/inspec/run_inspec.sh",
          "if [ -x \"$(command -v /usr/local/bin/vault)\" ]; then     echo \"role: consul\" > /opt/chef/inspec/role.yml;   else     echo \"role: vault\" > /opt/chef/inspec/role.yml;   fi",
          "chmod 0644 /etc/systemd/system/insp*",
          "systemctl enable inspec.timer",
          "systemctl start inspec.timer"
      ]
    },
    {
        "type": "inspec",
        "profile": "./tests/packer/vault",
        "only": [
            "Vault Image"
        ],
        "extra_arguments": [
            "--chef-license=accept-silent",
            "--sudo"
        ]
    },
    {
        "type": "inspec",
        "profile": "./tests/packer/consul",
        "only": [
            "Consul Image"
        ],
        "extra_arguments": [
            "--chef-license=accept-silent",
            "--sudo"
        ]
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'",
      "scripts": [
        "{{pwd}}/scripts/cleanup.sh"
      ]
    }
]
}
